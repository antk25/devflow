# Phase 2.5: Feature Contract (C-DAD, Dual: Claude + Qwen)

Contract-Driven AI Development: generate a feature contract, save to Obsidian for user review, then use as source of truth for all agents.

## When to Generate a Contract

**Generate contract** if ANY of these conditions are true:
- Plan contains **2+ tasks touching different layers** (API + DB, Handler + Event, Controller + Service, etc.)
- Feature is **multi-repo** (frontend + backend)
- Plan includes **new domain events** or **event handler changes**
- Plan includes **database schema changes** (new tables, new columns, migrations)

**Skip contract** if ALL of these are true:
- Single task or single-file change
- Single layer (e.g., just a service refactor, just a UI fix)
- No schema changes, no events, no API changes

When skipping, set `feature_contract = ""` and proceed to Phase 3.

## Step 1a: Claude Architect Agent

Spawn Architect to generate the feature contract:

```
Task(
  description: "Feature Contract: <feature>",
  prompt: "Generate a feature contract for this development task.

  Feature: <feature description>
  Plan tasks: <all task summaries from Phase 2>
  Repository/ies: <repo paths>

  <if deep_trace_results exists, append:>
  Deep Trace findings: <deep_trace_results>
  <endif>

  Analyze the plan and generate a contract with ONLY the sections that apply:
  - API section: if new/modified endpoints
  - DTO section: if new commands/queries/response objects
  - Events section: if domain events are dispatched or consumed
  - Database section: if schema changes (tables, columns, indexes)
  - Component section: if frontend components (multi-repo only)

  Use the C-DAD contract template format (Markdown + YAML code blocks).
  Write content in Russian (descriptions, headers) with English code identifiers in YAML.
  Include branch name: <work_branch_name>

  Return the COMPLETE contract file content including frontmatter.",
  subagent_type: "Architect"
)
```

## Step 1b: Qwen Contract (always runs, skip with `--no-qwen`)

**Run IN PARALLEL with Step 1a** using the MCP tool:

```
mcp__qwen-review__qwen_contract(
  task: "<feature description>",
  plan: "<all task summaries from Phase 2, joined with newlines>",
  context: "<combine all available context:>

  Repository/ies: <repo paths>
  Branch: <work_branch_name>

  <if deep_trace_results exists, append:>
  ## Deep Trace Results
  <deep_trace_results as JSON>
  <endif>

  <if rag_context is not empty, append:>
  ## Project Knowledge Base Context
  <rag_context>
  <endif>

  Generate contract in C-DAD format (Markdown + YAML code blocks).
  Write descriptions in Russian, code identifiers in English.
  Include ONLY applicable sections: API, DTO, Events, Database, Components."
)
```

**IMPORTANT:** Launch Step 1a (Task) and Step 1b (MCP call) in the same message to run them in parallel. Both return independently. Collect both results before proceeding to Step 1c.

**If Qwen MCP tool is unavailable** (server not running, tool not found), log a warning and continue with Claude-only contract. Do not fail the pipeline.

## Step 1c: Merge Contracts

Merge both contracts into a unified Dual Contract (see `templates/dual-contract-format.md`).

**Merge rules:**
1. **Sections:** Union of all sections from both contracts. If both have the same section (e.g., API), merge entries within it
2. **YAML entries:** If both define the same endpoint/DTO/event/table, keep Claude's version as primary but annotate differences from Qwen as comments
3. **Extra entries:** Fields/endpoints/columns proposed by only one are tagged `# [Claude]` or `# [Qwen]` as YAML comments
4. **Descriptions:** Use Claude's Russian descriptions as primary
5. **Conflicts:** If YAML field types disagree, note both: `type: string # [Claude: string, Qwen: int] — verify`

The **merged contract** uses Claude as the base, enriched with Qwen's additions and annotated disagreements for the user to resolve during review.

Store merged result as `feature_contract`.

## Step 2: Save Contract to Obsidian

1. Read `obsidian_vault` from `.claude/data/projects.json`
2. Build path: `<obsidian_vault>/projects/<project>/contracts/<branch>-<feature_slug>.md`
3. Create directory if needed: `mkdir -p <obsidian_vault>/projects/<project>/contracts/`
4. Write the contract file
5. Store the full path as `contract_path`

```bash
mkdir -p <obsidian_vault>/projects/<project>/contracts/
# Write contract content to file
```

## Step 3: Pause for User Review

**IMPORTANT:** This is the only intentional pause in the autonomous pipeline.

Print to user:

```markdown
## Dual Feature Contract Generated (Claude + Qwen)

**Saved to:** `<contract_path>`
**Open in Obsidian:** `projects/<project>/contracts/<filename>`

The contract was generated by both Claude and Qwen in parallel.
- Agreed entries are unmarked
- Entries from one source are tagged `[Claude]` or `[Qwen]`
- Disagreements are annotated with both values — please resolve

Review and edit in Obsidian, then type `go` to continue.
```

Wait for user to respond (any message = continue).

## Step 4: Re-read Contract and Update Status

1. Read the contract from `contract_path` (user may have edited it)
2. Update frontmatter `status: draft` → `status: approved` in the file
3. Store the (potentially edited) content as `feature_contract`

**Checkpoint:**
```bash
./scripts/session-checkpoint.sh <branch> phase_3_implement contract_path='<path>'
```

---

## Contract Gate (mandatory before Phase 3)

**CRITICAL:** Before starting Phase 3, you MUST run the contract gate script:

```bash
# Get plan summary from Phase 2 (task descriptions joined)
PLAN_SUMMARY="<all task descriptions from PM plan, joined with semicolons>"
CONTRACT_DECISION=$(./scripts/require-contract.sh <branch> "$PLAN_SUMMARY")
```

**Exit code 3 = CONTRACT_REQUIRED:**
→ You MUST execute Phase 2.5 (Feature Contract) before proceeding.
→ Do NOT skip to Phase 3.

**Exit code 0 = CONTRACT_SKIP:**
→ Contract not needed, proceed directly to Phase 3.
→ Run checkpoint: `./scripts/session-checkpoint.sh <branch> phase_3_implement`

**This gate CANNOT be bypassed.** If the script says CONTRACT_REQUIRED and you proceed without generating the contract, the session-checkpoint.sh will block the transition to phase_3_implement.

See also: `templates/dual-contract-format.md`
